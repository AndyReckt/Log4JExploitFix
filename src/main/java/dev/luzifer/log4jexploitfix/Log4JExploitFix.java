package dev.luzifer.log4jexploitfix;

import org.bukkit.Bukkit;
import org.bukkit.event.EventHandler;
import org.bukkit.event.EventPriority;
import org.bukkit.event.Listener;
import org.bukkit.event.player.AsyncPlayerChatEvent;
import org.bukkit.plugin.java.JavaPlugin;

import java.util.logging.Logger;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public final class Log4JExploitFix extends JavaPlugin implements Listener {
    
    private static final Pattern pattern = Pattern.compile("jndi:ldap");
    private final Logger logger = getLogger();
    
    @Override
    public void onEnable() {
        Bukkit.getPluginManager().registerEvents(this, this);
    }
    
    @Override
    public void onDisable() {}
    
    @EventHandler (priority = EventPriority.HIGHEST)
    public void onChat(AsyncPlayerChatEvent event) {
    
        Matcher matcher = pattern.matcher(event.getMessage().toLowerCase());
        if(matcher.find()) {
            logger.severe(event.getPlayer().getName() + " just tried something malicious");
            event.setCancelled(true);
        }
    }
}
