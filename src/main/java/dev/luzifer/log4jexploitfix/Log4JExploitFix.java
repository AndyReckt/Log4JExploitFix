package dev.luzifer.log4jexploitfix;

import com.comphenix.protocol.PacketType;
import com.comphenix.protocol.ProtocolLibrary;
import com.comphenix.protocol.ProtocolManager;
import com.comphenix.protocol.events.ListenerPriority;
import com.comphenix.protocol.events.PacketAdapter;
import com.comphenix.protocol.events.PacketContainer;
import com.comphenix.protocol.events.PacketEvent;
import org.bukkit.plugin.java.JavaPlugin;

import java.util.logging.Logger;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

public final class Log4JExploitFix extends JavaPlugin {
    
    static final Pattern pattern = Pattern.compile("jndi:(?:ldap|rmi|iiop)");
    private final Logger logger = getLogger();
    
    private ProtocolManager protocolManager;
    
    @Override
    public void onLoad() {
        LogPatternPatcher.tryPatch(this.logger);
        protocolManager = ProtocolLibrary.getProtocolManager();
    }
    
    @Override
    public void onEnable() {
        
        protocolManager.addPacketListener(new PacketAdapter(this, ListenerPriority.LOWEST,
                PacketType.Play.Client.CHAT) {
    
            @Override
            public void onPacketReceiving(PacketEvent event) {
                
                if(event.getPacketType() == PacketType.Play.Client.CHAT) {
    
                    PacketContainer packetContainer = event.getPacket();
                    String message = packetContainer.getStrings().read(0);
                    
                    Matcher matcher = pattern.matcher(message.toLowerCase());
                    
                    if(matcher.find()) {
                        logger.severe(event.getPlayer().getName() + " just tried something malicious");
                        event.setCancelled(true);
                        packetContainer.getStrings().write(0, "");
                    }
                
                }
            }
        });
    }
    
    @Override
    public void onDisable() {}
}
